name: E2E

on: [pull_request]

jobs:
  commit_hash:
    name: Wait for Preview
    runs-on: "ubuntu-latest"
    steps:
      # - name: Find It
      #   run: |
      #     sleep 10
      #     CURRENT_HASH=${{ github.event.after }}
      #     echo $CURRENT_HASH
      #     curl -s -H 'Accept: application/json' -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" "https://api.vercel.com/v6/now/deployments?teamId=tone-row&name=flowchart-fun" | jq ".deployments[] | select(.meta.githubCommitSha==$CURRENT_HASH)"
      - name: One At A Time
        run: |
          CURRENT_HASH=${{ github.event.after }}
          echo Current Hash $CURRENT_HASH
          RESULTS=$(curl -s -H 'Accept: application/json' -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" "https://api.vercel.com/v6/now/deployments?teamId=tone-row&name=flowchart-fun")
          STATE=$(echo $RESULTS | jq ".deployments[] | .meta.githubCommitSha")
          echo $STATE
      # - name: Wait for ready
      #   run: |
      #     STATE="not ready"
      #     CURRENT_HASH=${{ github.event.after }}
      #     echo $CURRENT_HASH
      #     until [ "$STATE" = '"READY"' ]
      #     do
      #       RESULT=$(curl -s -H 'Accept: application/json' -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" "https://api.vercel.com/v6/now/deployments?teamId=tone-row&name=flowchart-fun")
      #       STATE=$(echo $RESULT | jq ".deployments[] | select(.meta.githubCommitSha=='$CURRENT_HASH') | .state")
      #       echo $STATE
      #       sleep 5
      #     done
      #     echo "Deployment is ready!"
