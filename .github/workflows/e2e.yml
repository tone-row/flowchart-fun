name: E2E

on: [pull_request]

jobs:
  commit_hash:
    name: Wait for Preview
    runs-on: "ubuntu-latest"
    steps:
      - name: Wait until ready
        id: get_url
        run: |
          STATE="not ready"
          CURRENT_HASH=${{ github.event.after }}
          echo $CURRENT_HASH
          until [ "$STATE" = '"READY"' ]
          do
            RESULTS=$(curl -s -H 'Accept: application/json' -H "Authorization: Bearer ${{ secrets.VERCEL_TOKEN }}" "https://api.vercel.com/v6/now/deployments?teamId=tone-row&name=flowchart-fun")
            CLEAN=$(echo $RESULTS | tr -d '[:cntrl:]')
            STATE=$(echo $CLEAN | jq --arg h "$CURRENT_HASH" '.deployments[] | select(.meta.githubCommitSha==$h) | .state');
            echo $STATE
            sleep 5
          done
          echo "Deployment is ready!"
          URL=https://$(echo $CLEAN | jq --arg h "$CURRENT_HASH" '.deployments[] | select(.meta.githubCommitSha==$h) | .url')
          echo ::set-output name=preview_url::$(echo $URL)
      - run: echo ${{ steps.get_url.outputs.preview_url }}
